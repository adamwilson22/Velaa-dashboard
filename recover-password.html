<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recover Password - Fleet Management System</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/responsive.css">
    <link rel="stylesheet" href="css/api-components.css">
</head>
<body class="page page--auth page--recover-password page--login">
    <div class="auth-layout">
        <!-- Recover Password Form Section -->
        <div class="auth-layout__form">
            <div class="auth-layout__content">
                <h1 class="auth-layout__title">Recover password</h1>
                <p class="auth-layout__subtitle" id="recoverSubtitle">Enter codes sent to your phone number</p>
                <p class="auth-layout__subtitle" style="font-size: 14px; color: #666; margin-top: 8px;" id="recoveryDemoHint">ðŸ’¡ Demo mode: Use <strong>1234</strong> as recovery code</p>

                <form class="form" id="recoverPasswordForm">
                    <div class="form__fields">
                        <div class="form__group">
                            <div class="otp-inputs" id="otpInputs">
                                <input type="text" maxlength="1" class="form__input form__input--otp" id="otp1" required>
                                <input type="text" maxlength="1" class="form__input form__input--otp" id="otp2" required>
                                <input type="text" maxlength="1" class="form__input form__input--otp" id="otp3" required>
                                <input type="text" maxlength="1" class="form__input form__input--otp" id="otp4" required>
                            </div>
                        </div>

                        <div class="form__group" style="text-align: left; margin-bottom: 2rem;">
                            <a href="#" class="form__link" id="resendRecoveryLink">Resend codes</a>
                            <span id="resendRecoveryTimer" style="margin-left: 10px; color: #666; display: none;"></span>
                        </div>
                    </div>

                    <div class="form__button-wrapper">
                        <button type="submit" class="btn btn--primary btn--full" id="verifyRecoveryBtn">
                            Continue
                        </button>
                    </div>
                </form>

                <div class="form__group" style="text-align: center; margin-top: 2rem;">
                    <p>
                        Remember your password? <a href="index.html" class="form__link--primary">Back to Login</a>
                    </p>
                </div>

                <div class="auth-layout__footer">
                    <p>2025 Clickit Solutions All Right Received</p>
                </div>
            </div>
        </div>

        <!-- Branding Section -->
        <div class="auth-layout__branding">
            <img src="images/home.png" alt="Fleet branding" class="auth-layout__image">
        </div>
    </div>

    <script src="js/api.js"></script>
    <script src="js/navigation.js"></script>
    <script src="js/scripts.js"></script>
    <script>
        // Password Recovery OTP Page Handler
        document.addEventListener('DOMContentLoaded', function() {
            const recoverPasswordForm = document.getElementById('recoverPasswordForm');
            const verifyRecoveryBtn = document.getElementById('verifyRecoveryBtn');
            const resendRecoveryLink = document.getElementById('resendRecoveryLink');
            const resendRecoveryTimer = document.getElementById('resendRecoveryTimer');
            const recoverSubtitle = document.getElementById('recoverSubtitle');
            const otpInputs = document.querySelectorAll('.form__input--otp');
            
            let resendCountdown = 30;
            let resendTimerInterval;
            let resetPhone = '';
            
            // Check if user came from forgot password
            function initializePage() {
                resetPhone = sessionStorage.getItem('resetPhone');
                
                if (!resetPhone) {
                    NotificationManager.error('Session expired. Please start password recovery again.');
                    setTimeout(() => {
                        if (window.navigationManager && typeof window.navigationManager.navigateTo === 'function') {
                            window.navigationManager.navigateTo('forgot-password.html', 'Redirecting...');
                        } else {
                            window.location.href = 'forgot-password.html';
                        }
                    }, 2000);
                    return false;
                }
                
                // Update subtitle with masked phone number
                let maskedPhone;
                if (resetPhone.startsWith('+255')) {
                    maskedPhone = resetPhone.replace(/(\+255)(\d{2})(\d{3})(\d{4})/, '$1 $2 *** $4');
                } else {
                    maskedPhone = resetPhone.replace(/(\+\d{1,3})(\d{2,3})(\d{3,4})(\d{3,4})/, '$1 $2 *** $4');
                }
                recoverSubtitle.textContent = `Enter recovery code sent to ${maskedPhone}`;
                
                // Start resend timer
                startResendTimer();
                
                return true;
            }
            
            // OTP input management (reusing from registration OTP)
            function setupOTPInputs() {
                otpInputs.forEach((input, index) => {
                    // Input event handler
                    input.addEventListener('input', (e) => {
                        let value = e.target.value.replace(/\D/g, ''); // Only allow digits
                        e.target.value = value;
                        
                        if (value.length === 1) {
                            e.target.classList.add('has-value');
                            // Auto-focus next input
                            if (index < otpInputs.length - 1) {
                                otpInputs[index + 1].focus();
                            }
                            
                            // Auto-submit when all fields are filled
                            checkAutoSubmit();
                        } else {
                            e.target.classList.remove('has-value');
                        }
                    });
                    
                    // Keydown event handler
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Backspace' && !e.target.value && index > 0) {
                            otpInputs[index - 1].focus();
                            otpInputs[index - 1].value = '';
                            otpInputs[index - 1].classList.remove('has-value');
                        }
                        
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            submitRecoveryOTP();
                        }
                    });
                    
                    // Focus and blur events
                    input.addEventListener('focus', (e) => {
                        e.target.style.borderColor = '#000000';
                        e.target.style.boxShadow = '0 0 0 3px rgba(0, 0, 0, 0.1)';
                    });
                    
                    input.addEventListener('blur', (e) => {
                        if (!e.target.value) {
                            e.target.style.borderColor = '#e1e5e9';
                            e.target.style.boxShadow = 'none';
                        }
                    });
                    
                    // Paste event handler
                    input.addEventListener('paste', (e) => {
                        e.preventDefault();
                        const pastedData = e.clipboardData.getData('text').replace(/\D/g, '');
                        
                        if (pastedData.length === 4) {
                            otpInputs.forEach((inp, idx) => {
                                if (pastedData[idx]) {
                                    inp.value = pastedData[idx];
                                    inp.classList.add('has-value');
                                }
                            });
                            
                            otpInputs[3].focus();
                            checkAutoSubmit();
                        }
                    });
                });
            }
            
            // Check if all OTP fields are filled for auto-submit
            function checkAutoSubmit() {
                const otpValues = Array.from(otpInputs).map(input => input.value);
                if (otpValues.every(value => value.length === 1)) {
                    setTimeout(() => submitRecoveryOTP(), 500);
                }
            }
            
            // Get complete OTP
            function getOTPValue() {
                return Array.from(otpInputs).map(input => input.value).join('');
            }
            
            // Validate OTP
            function validateOTP() {
                const otp = getOTPValue();
                
                if (otp.length !== 4) {
                    NotificationManager.error('Please enter the complete 4-digit recovery code');
                    otpInputs[0].focus();
                    return false;
                }
                
                if (!/^\d{4}$/.test(otp)) {
                    NotificationManager.error('Recovery code should contain only digits');
                    otpInputs[0].focus();
                    return false;
                }
                
                return true;
            }
            
            // Submit recovery OTP
            async function submitRecoveryOTP() {
                if (!validateOTP()) {
                    return;
                }
                
                const otp = getOTPValue();
                
                try {
                    // Show loading state
                    loadingManager.show('recovery-otp', 'Verifying recovery code...');
                    verifyRecoveryBtn.classList.add('btn--loading');
                    
                    // Disable form inputs
                    const inputs = recoverPasswordForm.querySelectorAll('input, button, a');
                    inputs.forEach(input => {
                        input.disabled = true;
                        if (input.tagName === 'INPUT') {
                            input.classList.add('form__input--loading');
                        }
                    });
                    
                    // Make API call
                    const response = await window.velaaAPI.verifyRecoveryOTP(resetPhone, otp);
                    
                    if (response.success) {
                        // Store OTP for password reset
                        sessionStorage.setItem('resetOTP', otp);
                        
                        // Show success message
                        NotificationManager.success('Recovery code verified successfully!');
                        
                        // Navigate to reset password page
                        setTimeout(() => {
                            if (window.navigationManager && typeof window.navigationManager.navigateTo === 'function') {
                                window.navigationManager.navigateTo('reset-password.html', 'Proceeding to password reset...');
                            } else {
                                window.location.href = 'reset-password.html';
                            }
                        }, 1500);
                    } else {
                        throw new Error(response.message || 'Recovery code verification failed');
                    }
                    
                } catch (error) {
                    console.error('Recovery OTP verification error:', error);
                    
                    // Show error message
                    if (error instanceof APIError) {
                        NotificationManager.error(error.getUserMessage());
                    } else {
                        NotificationManager.error('Recovery code verification failed. Please try again.');
                    }
                    
                    // Clear OTP inputs
                    otpInputs.forEach(input => {
                        input.value = '';
                        input.classList.remove('has-value');
                    });
                    otpInputs[0].focus();
                    
                    // Re-enable form
                    const inputs = recoverPasswordForm.querySelectorAll('input, button, a');
                    inputs.forEach(input => {
                        input.disabled = false;
                        if (input.tagName === 'INPUT') {
                            input.classList.remove('form__input--loading');
                        }
                    });
                    
                } finally {
                    // Hide loading state
                    loadingManager.hide('recovery-otp');
                    verifyRecoveryBtn.classList.remove('btn--loading');
                }
            }
            
            // Handle form submission
            recoverPasswordForm.addEventListener('submit', function(e) {
                e.preventDefault();
                submitRecoveryOTP();
            });
            
            // Resend timer functionality
            function startResendTimer() {
                resendCountdown = 30;
                resendRecoveryLink.style.pointerEvents = 'none';
                resendRecoveryLink.style.opacity = '0.6';
                resendRecoveryTimer.style.display = 'inline';
                
                resendTimerInterval = setInterval(() => {
                    resendRecoveryTimer.textContent = `(${resendCountdown}s)`;
                    resendCountdown--;
                    
                    if (resendCountdown < 0) {
                        clearInterval(resendTimerInterval);
                        resendRecoveryLink.style.pointerEvents = 'auto';
                        resendRecoveryLink.style.opacity = '1';
                        resendRecoveryTimer.style.display = 'none';
                    }
                }, 1000);
            }
            
            // Resend recovery code functionality
            async function resendRecoveryCode() {
                try {
                    // Show loading state
                    loadingManager.show('resend-recovery', 'Resending recovery code...');
                    resendRecoveryLink.textContent = 'Sending...';
                    resendRecoveryLink.style.pointerEvents = 'none';
                    
                    // Make API call
                    const response = await window.velaaAPI.forgotPassword(resetPhone);
                    
                    if (response.success) {
                        NotificationManager.success('Recovery code resent successfully!');
                        
                        // Clear current OTP inputs
                        otpInputs.forEach(input => {
                            input.value = '';
                            input.classList.remove('has-value');
                        });
                        otpInputs[0].focus();
                        
                        // Restart timer
                        resendRecoveryLink.textContent = 'Resend codes';
                        startResendTimer();
                    } else {
                        throw new Error(response.message || 'Failed to resend recovery code');
                    }
                    
                } catch (error) {
                    console.error('Resend recovery code error:', error);
                    
                    if (error instanceof APIError) {
                        NotificationManager.error(error.getUserMessage());
                    } else {
                        NotificationManager.error('Failed to resend recovery code. Please try again.');
                    }
                    
                    resendRecoveryLink.textContent = 'Resend codes';
                    resendRecoveryLink.style.pointerEvents = 'auto';
                    
                } finally {
                    loadingManager.hide('resend-recovery');
                }
            }
            
            // Resend link click handler
            resendRecoveryLink.addEventListener('click', function(e) {
                e.preventDefault();
                resendRecoveryCode();
            });
            
            // Initialize page
            if (initializePage()) {
                setupOTPInputs();
                otpInputs[0].focus();
            }
        });
    </script>
</body>
</html>

